name: Rust

on:
  push:
    branches: [main, "rust-v*"]
  pull_request:
    branches: [main, "rust-v*"]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions-rs/toolchain@v1
        with:
          profile: default
          toolchain: stable
          override: true
          components: rustfmt, clippy

      - uses: Swatinem/rust-cache@v1

      - name: Setup Python
        uses: actions/setup-python@v3
        id: setup-python
        with:
          python-version: 3.9

      - name: Install protobuf compiler in /protoc
        run: |
          sudo mkdir /protoc
          sudo chmod a+rwx /protoc
          cd /protoc
          curl -LO https://github.com/protocolbuffers/protobuf/releases/download/v21.4/protoc-21.4-linux-x86_64.zip
          unzip protoc-21.4-linux-x86_64.zip

      - uses: mbrobbel/rustfmt-check@master
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run clippy
        run: |
          cargo clippy -- -D warnings

      - name: Run tests
        shell: bash
        run: |
          # do not produce debug symbols to keep memory usage down
          export RUSTFLAGS="-C debuginfo=0"
          cargo test

      - name: Publish unit test results
        uses: EnricoMi/publish-unit-test-result-action@v1
        if: always()

      - name: Run coverage
        run: |
          export PATH=$PATH:/protoc/bin
          rustup toolchain install stable
          rustup default stable
          cargo install --version 0.18.2 cargo-tarpaulin
          cargo tarpaulin --all --out Xml

      - name: Report coverage
        continue-on-error: true
        run: bash <(curl -s https://codecov.io/bash)
